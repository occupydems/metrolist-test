name: 'Setup FFTW for Android'
description: 'Build and cache FFTW static libraries for Android ABIs'

inputs:
  fftw-version:
    description: 'FFTW version to build'
    required: false
    default: '3.3.10'
  api-level:
    description: 'Android API level'
    required: false
    default: '26'

runs:
  using: 'composite'
  steps:
    - name: Cache FFTW libraries
      id: cache-fftw
      uses: actions/cache@v4
      with:
        path: app/src/main/cpp/vibrafp/third_party/fftw-android
        key: fftw-${{ inputs.fftw-version }}-api${{ inputs.api-level }}-allabi-v1

    - name: Build FFTW for Android
      if: steps.cache-fftw.outputs.cache-hit != 'true'
      shell: bash
      env:
        FFTW_VERSION: ${{ inputs.fftw-version }}
        API: ${{ inputs.api-level }}
        OUT_BASE: app/src/main/cpp/vibrafp/third_party/fftw-android
      run: |
        NDK_PATH=""
        for p in "$ANDROID_NDK_HOME" "$ANDROID_NDK" "/usr/local/lib/android/sdk/ndk/27.0.12077973"; do
          if [ -d "$p" ]; then NDK_PATH="$p"; break; fi
        done
        if [ -z "$NDK_PATH" ]; then
          NDK_PATH=$(find /usr/local/lib/android/sdk/ndk -maxdepth 1 -type d -name "[0-9]*" 2>/dev/null | sort -V | tail -1)
        fi
        if [ -z "$NDK_PATH" ] || [ ! -d "$NDK_PATH" ]; then
          echo "ERROR: Could not find Android NDK"
          exit 1
        fi
        echo "Using NDK at: $NDK_PATH"
        cd app/src/main/cpp/vibrafp/third_party
        chmod +x build-fftw-android.sh
        ./build-fftw-android.sh --ndk "$NDK_PATH" --out "$GITHUB_WORKSPACE/$OUT_BASE" --version "$FFTW_VERSION" --api "$API"

    - name: Verify FFTW installation
      shell: bash
      run: |
        echo "FFTW installation:"
        for abi in arm64-v8a armeabi-v7a x86_64 x86; do
          if [ -f "app/src/main/cpp/vibrafp/third_party/fftw-android/$abi/lib/libfftw3.a" ]; then
            echo "  OK: $abi"
          else
            echo "  MISSING: $abi"
          fi
        done
